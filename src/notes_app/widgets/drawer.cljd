(ns notes-app.widgets.drawer
  (:require
   ["package:flutter/material.dart" :as m]
   ["package:mongol/mongol.dart" :as mgl]
   [electric-sync.state :as es-state]
   [electric-sync.token :as token]
   [notes-app.utils.navigator :as navigator]
   [notes-app.widgets.favorite-list :as fal]
   [notes-app.states.notes :as notes]
   [notes-app.services.backup :as backup]
   [cljd.flutter :as f]
   [notes-app.utils.i18n :as i18n]))

(defn mgl-left-drawer []
  (f/widget
   :context ctx
   :get [m/Navigator]
   :let [theme (-> m/Theme (.of ctx))
         color-scheme (-> theme .-colorScheme)
         bg-color (-> color-scheme .-primaryContainer)
         scaffold-bg-color (-> color-scheme .-surface)]
   :watch [uid es-state/uid]
   (m/Drawer)
   (m/SafeArea)
   (m/Container
    .decoration (m/BoxDecoration
                 .color scaffold-bg-color))
   (m/Column
    .children
    [(m/Container
      .padding (m/EdgeInsets.symmetric .vertical 20 .horizontal 16)
      .decoration (m/BoxDecoration
                   .color bg-color)
      .child (m/Row
              .mainAxisAlignment m/MainAxisAlignment.spaceBetween
              .children
              [(m/CircleAvatar
                .radius 20
                .backgroundColor (m/Colors.grey 400)
                .child (m/IconButton
                        .icon (m/Icon m/Icons.menu)
                        .onPressed #(dart:core/print "Open avatar")))
               (m/IconButton
                .icon (m/Icon m/Icons.settings)
                .onPressed (fn []
                             (dart:core/print "Open Settings")))]))
     (m/Divider .height 1)
     (m/Expanded
      .child
      (m/Column
       .children
       [(m/Flexible
         .flex 1
         .child
         (m/SingleChildScrollView
          .scrollDirection m/Axis.horizontal
          .child
          (m/Row
           .mainAxisAlignment m/MainAxisAlignment.start
           .children
           [(if (and false (empty? uid))
              ;; TODO: Remove this once we have a login screen
              (mgl/MongolListTile
               .leading (m/Icon m/Icons.login)
               .title (mgl/MongolText (i18n/t ctx :drawer/login))
               .onTap (fn []
                        (-> m/Scaffold (.of ctx) .closeDrawer)
                        (navigator/navigate-to-screen navigator "/login")))
              (m/SizedBox))
            (mgl/MongolListTile
             .leading (m/Icon m/Icons.info_outline)
             .title (mgl/MongolText (i18n/t ctx :drawer/about))
             .onTap (fn []
                      (navigator/navigate-to-screen navigator "/about")))
            (mgl/MongolListTile
             .leading (m/Icon m/Icons.restore_from_trash)
             .title (mgl/MongolText (i18n/t ctx :drawer/recycle))
             .onTap (fn []
                      (-> m/Scaffold (.of ctx) .closeDrawer)
                      (notes/load-deleted-notes! ctx 0 20)
                      (navigator/navigate-to-screen navigator "/recycle")))
            (mgl/MongolListTile
             .leading (m/Icon m/Icons.backup)
             .title (mgl/MongolText (i18n/t ctx :drawer/backup))
             .onTap (fn []
                      (-> m/Scaffold (.of ctx) .closeDrawer)
                      (navigator/navigate-to-screen navigator "/backup")))
            (mgl/MongolListTile
             .leading (m/Icon m/Icons.settings)
             .title (mgl/MongolText (i18n/t ctx :drawer/settings))
             .onTap (fn []
                      (-> m/Scaffold (.of ctx) .closeDrawer)
                      (navigator/navigate-to-screen navigator "/settings")))
            (if-not (empty? uid)
              (mgl/MongolListTile
               .leading (m/Icon m/Icons.logout)
               .title (mgl/MongolText (i18n/t ctx :drawer/logout))
               .onTap (fn []
                        (-> m/Scaffold (.of ctx) .closeDrawer)
                        (token/clean)
                        ;; Reload notes list after logout
                        (notes/load-notes-paginated! ctx 0)))
              (m/SizedBox))])))
        (m/Divider .height 1)
        (m/Flexible
         .flex 2
         .child (fal/fa-list))]))])))